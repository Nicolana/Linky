const { ipcRenderer } = require('electron');
const path = require('path');
const fs = require('fs');

// DOM ÂÖÉÁ¥†
const deviceList = document.getElementById('deviceList');
const fileList = document.getElementById('fileList');
const searchInput = document.getElementById('searchInput');
const selectDirBtn = document.getElementById('selectDir');
const transferWindow = document.getElementById('transferWindow');
const transferList = document.getElementById('transferList');
const networkSpeed = document.getElementById('networkSpeed');
const transferCount = document.getElementById('transferCount');
const receiveList = document.getElementById('receiveList');

// Áä∂ÊÄÅÁÆ°ÁêÜ
let devices = new Map();
let files = [];
let transfers = new Map();
let receives = new Map();
let selectedDeviceIp = null;
let localIPs = []; // ‰øùÂ≠òÊú¨Êú∫IPÂàóË°®

// Êé•Êî∂Êú¨Êú∫IPÂàóË°®
ipcRenderer.on('local-ips', (event, ips) => {
    console.log('Êî∂Âà∞Êú¨Êú∫IPÂàóË°®:', ips);
    localIPs = ips;
});

// Ê£ÄÊü•IPÊòØÂê¶‰∏∫Êú¨Êú∫IP
function isLocalIP(ip) {
    return localIPs.includes(ip) || ip === '127.0.0.1' || ip === 'localhost';
}

// ËÆæÂ§áÂèëÁé∞Â§ÑÁêÜ
ipcRenderer.on('device-discovered', (event, deviceInfo) => {
    console.log('ÂèëÁé∞ËÆæÂ§á:', deviceInfo);
    
    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊú¨Êú∫IP
    if (isLocalIP(deviceInfo.ip)) {
        console.log('ÂøΩÁï•Êú¨Êú∫ËÆæÂ§á:', deviceInfo.ip);
        return;
    }
    
    // Êõ¥Êñ∞ËÆæÂ§á‰ø°ÊÅØ
    devices.set(deviceInfo.ip, deviceInfo);
    updateDeviceList();
});

// Ê∏ÖÁêÜÁ¶ªÁ∫øËÆæÂ§á
ipcRenderer.on('clean-offline-devices', (event, { threshold, currentTime }) => {
    let hasChanges = false;
    
    // ÈÅçÂéÜÊâÄÊúâËÆæÂ§áÔºåÁßªÈô§Ë∂ÖÊó∂ÁöÑËÆæÂ§á
    for (const [ip, device] of devices.entries()) {
        if (currentTime - device.lastSeen > threshold) {
            console.log(`ËÆæÂ§áÁ¶ªÁ∫ø: ${device.name} (${ip})`);
            devices.delete(ip);
            hasChanges = true;
            
            // Â¶ÇÊûúÂΩìÂâçÈÄâ‰∏≠ÁöÑËÆæÂ§áÁ¶ªÁ∫ø‰∫ÜÔºåÊ∏ÖÈô§ÈÄâ‰∏≠Áä∂ÊÄÅ
            if (selectedDeviceIp === ip) {
                selectedDeviceIp = null;
            }
        }
    }
    
    // Â¶ÇÊûúÊúâËÆæÂ§áË¢´ÁßªÈô§ÔºåÊõ¥Êñ∞ËÆæÂ§áÂàóË°®
    if (hasChanges) {
        updateDeviceList();
    }
});

// Êõ¥Êñ∞ËÆæÂ§áÂàóË°®
function updateDeviceList() {
    deviceList.innerHTML = Array.from(devices.values())
        .map(device => `
            <div class="device-item ${device.ip === selectedDeviceIp ? 'selected' : ''}" data-ip="${device.ip}">
                <div class="device-status ${device.status === 'online' ? 'status-online' : 'status-offline'}"></div>
                <div class="device-info">
                    <div class="device-name">${device.name}</div>
                    <div class="device-ip">${device.ip}</div>
                </div>
            </div>
        `).join('');

    // Ê∑ªÂä†ËÆæÂ§áÈÄâÊã©‰∫ã‰ª∂ÁõëÂê¨
    deviceList.querySelectorAll('.device-item').forEach(item => {
        item.addEventListener('click', () => {
            // Êõ¥Êñ∞ÈÄâ‰∏≠ËÆæÂ§áIP
            selectedDeviceIp = item.dataset.ip;
            // ÁßªÈô§ÂÖ∂‰ªñËÆæÂ§áÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            deviceList.querySelectorAll('.device-item').forEach(d => d.classList.remove('selected'));
            // Ê∑ªÂä†ÂΩìÂâçËÆæÂ§áÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
            item.classList.add('selected');
        });
    });
}

// ÈÄâÊã©ÂÖ±‰∫´ÁõÆÂΩï
selectDirBtn.addEventListener('click', async () => {
    const dirPath = await ipcRenderer.invoke('select-directory');
    if (dirPath) {
        loadFiles(dirPath);
    }
});

// Âä†ËΩΩÊñá‰ª∂ÂàóË°®
function loadFiles(dirPath) {
    fs.readdir(dirPath, (err, items) => {
        if (err) {
            console.error('Error reading directory:', err);
            return;
        }

        files = items.map(item => {
            const fullPath = path.join(dirPath, item);
            const stats = fs.statSync(fullPath);
            return {
                name: item,
                path: fullPath,
                size: stats.size,
                modified: stats.mtime,
                isDirectory: stats.isDirectory()
            };
        });

        updateFileList();
    });
}

// Êõ¥Êñ∞Êñá‰ª∂ÂàóË°®
function updateFileList() {
    const searchTerm = searchInput.value.toLowerCase();
    const filteredFiles = files.filter(file => 
        file.name.toLowerCase().includes(searchTerm)
    );

    fileList.innerHTML = filteredFiles.map((file, index) => `
        <div class="file-item" data-index="${index}">
            <div class="col-name">
                <span class="file-icon">${file.isDirectory ? 'üìÅ' : 'üìÑ'}</span>
                ${file.name}
            </div>
            <div class="col-size">${formatFileSize(file.size)}</div>
            <div class="col-date">${formatDate(file.modified)}</div>
            <div class="col-actions">
                <button class="btn share-btn" data-index="${index}">ÂàÜ‰∫´</button>
            </div>
        </div>
    `).join('');
    
    // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ
    fileList.querySelectorAll('.share-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const index = parseInt(e.target.dataset.index);
            const fileToShare = filteredFiles[index];
            shareFile(fileToShare.path);
        });
    });
}

// Êñá‰ª∂ÊêúÁ¥¢
searchInput.addEventListener('input', updateFileList);

// Ê†ºÂºèÂåñÊñá‰ª∂Â§ßÂ∞è
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Ê†ºÂºèÂåñÊó•Êúü
function formatDate(date) {
    return new Date(date).toLocaleString();
}

// ÂàÜ‰∫´Êñá‰ª∂
async function shareFile(filePath) {
    console.log('ÂáÜÂ§áÂàÜ‰∫´Êñá‰ª∂:', filePath);
    
    // Á°Æ‰øùÊñá‰ª∂Ë∑ØÂæÑÊ†ºÂºèÊ≠£Á°ÆÔºàWindows Ë∑ØÂæÑ‰øÆÊ≠£Ôºâ
    if (process.platform === 'win32') {
        // Ê£ÄÊü•Ë∑ØÂæÑÊòØÂê¶Áº∫Â∞ëÂàÜÈöîÁ¨¶
        if (filePath.match(/^[A-Z]:(?![\\\/])/)) {
            // Âú®È©±Âä®Âô®Âè∑ÂêéÊ∑ªÂä†ÂàÜÈöîÁ¨¶
            filePath = filePath.replace(/^([A-Z]:)/, '$1\\');
            console.log('‰øÆÊ≠£ÂêéÁöÑË∑ØÂæÑ:', filePath);
        }
        
        // Á°Æ‰øù‰ΩøÁî®ÂèçÊñúÊù†‰Ωú‰∏∫Ë∑ØÂæÑÂàÜÈöîÁ¨¶
        filePath = filePath.replace(/\//g, '\\');
        
        // ‰øÆÂ§çÂèØËÉΩÁöÑËøûÁª≠ÂàÜÈöîÁ¨¶
        filePath = filePath.replace(/\\{2,}/g, '\\');
    }
    
    // Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®
    try {
        fs.accessSync(filePath, fs.constants.F_OK);
        console.log('Êñá‰ª∂Â≠òÂú®ÔºåÂºÄÂßã‰º†Ëæì');
    } catch (err) {
        console.error('Êñá‰ª∂‰∏çÂ≠òÂú®:', filePath, err);
        alert(`Êñá‰ª∂‰∏çÂ≠òÂú®: ${filePath}`);
        return;
    }
    
    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑËÆæÂ§á
    const selectedDevice = document.querySelector('.device-item.selected');
    if (!selectedDevice) {
        alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÁõÆÊ†áËÆæÂ§á');
        return;
    }

    const targetDevice = {
        ip: selectedDevice.dataset.ip,
        name: selectedDevice.querySelector('.device-name').textContent
    };
    
    console.log('‰º†ËæìÁõÆÊ†áËÆæÂ§á:', targetDevice);
    
    // Ê£ÄÊü•ÊòØÂê¶Ê≠£Âú®ÂêëËá™Â∑±ÂèëÈÄÅ
    if (isLocalIP(targetDevice.ip)) {
        console.error('ÈòªÊ≠¢ÂêëËá™Â∑±ÂèëÈÄÅÊñá‰ª∂:', targetDevice.ip);
        alert('‰∏çËÉΩÂêëËá™Â∑±ÂèëÈÄÅÊñá‰ª∂„ÄÇËØ∑ÈÄâÊã©ÂÖ∂‰ªñËÆæÂ§á‰Ωú‰∏∫ÁõÆÊ†á„ÄÇ');
        return;
    }
    
    const transferId = Date.now().toString();
    const transfer = {
        id: transferId,
        filePath: filePath,
        progress: 0,
        status: 'pending'
    };

    transfers.set(transferId, transfer);
    updateTransferList();
    updateTransferCount();

    try {
        // ÈÄöÁü•‰∏ªËøõÁ®ãÂºÄÂßã‰º†Ëæì
        const result = await ipcRenderer.invoke('start-transfer', {
            filePath,
            targetDevice
        });
        
        console.log('‰º†ËæìÂºÄÂßãÁªìÊûú:', result);
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ
        if (result && result.error) {
            alert(`‰º†ËæìÂ§±Ë¥•: ${result.error}`);
            transfers.delete(transferId);
            updateTransferList();
            updateTransferCount();
            return;
        }

        // ÁõëÂê¨‰º†ËæìËøõÂ∫¶
        ipcRenderer.on('transfer-progress', (event, data) => {
            if (data.id === transferId) {
                transfer.progress = data.progress;
                updateTransferList();
            }
        });

        // ÁõëÂê¨‰º†ËæìÂÆåÊàê
        ipcRenderer.on('transfer-completed', (event, id) => {
            if (id === transferId) {
                transfer.status = 'completed';
                transfer.progress = 100;
                updateTransferList();
            }
        });

        // ÁõëÂê¨‰º†ËæìÈîôËØØ
        ipcRenderer.on('transfer-error', (event, data) => {
            if (data.id === transferId) {
                transfer.status = 'error';
                alert(`‰º†ËæìÂ§±Ë¥•: ${data.error}`);
                updateTransferList();
            }
        });

    } catch (error) {
        console.error('‰º†ËæìÂêØÂä®Â§±Ë¥•:', error);
        alert('‰º†ËæìÂêØÂä®Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
        transfers.delete(transferId);
        updateTransferList();
        updateTransferCount();
    }
}

// Êõ¥Êñ∞‰º†ËæìÂàóË°®
function updateTransferList() {
    transferList.innerHTML = Array.from(transfers.values())
        .map(transfer => `
            <div class="transfer-item">
                <div class="transfer-info">
                    <div class="transfer-name">${path.basename(transfer.filePath)}</div>
                    <div class="transfer-progress">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: ${transfer.progress}%"></div>
                        </div>
                        <span>${transfer.progress}%</span>
                    </div>
                </div>
                <div class="transfer-actions">
                    <button class="btn-icon" onclick="cancelTransfer('${transfer.id}')">√ó</button>
                </div>
            </div>
        `).join('');
}

// Êõ¥Êñ∞‰º†ËæìËÆ°Êï∞
function updateTransferCount() {
    transferCount.textContent = transfers.size;
}

// ÂèñÊ∂à‰º†Ëæì
function cancelTransfer(transferId) {
    transfers.delete(transferId);
    updateTransferList();
    updateTransferCount();
}

// ÊòæÁ§∫/ÈöêËóè‰º†ËæìÁ™óÂè£
document.querySelector('.close-btn').addEventListener('click', () => {
    transferWindow.classList.add('hidden');
});

// Êõ¥Êñ∞ÁΩëÈÄüÊòæÁ§∫
function updateNetworkSpeed(speed) {
    networkSpeed.textContent = `${formatFileSize(speed)}/s`;
}

// ÁõëÂê¨Êñá‰ª∂Êé•Êî∂ËøõÂ∫¶
ipcRenderer.on('receive-progress', (event, data) => {
    // Êõ¥Êñ∞ÊàñÂàõÂª∫Êé•Êî∂ËÆ∞ÂΩï
    if (!receives.has(data.fileName)) {
        receives.set(data.fileName, {
            fileName: data.fileName,
            progress: data.progress,
            receivedBytes: data.receivedBytes,
            totalBytes: data.totalBytes,
            status: 'receiving'
        });
    } else {
        const receive = receives.get(data.fileName);
        receive.progress = data.progress;
        receive.receivedBytes = data.receivedBytes;
    }
    
    // Êõ¥Êñ∞Êé•Êî∂ÂàóË°®
    updateReceiveList();
    
    // ÊòæÁ§∫ÈÄöÁü•
    if (Notification.permission === 'granted' && data.progress === 0) {
        new Notification('Ê≠£Âú®Êé•Êî∂Êñá‰ª∂', {
            body: `Ê≠£Âú®Êé•Êî∂ ${data.fileName}`,
            icon: 'icon.png'
        });
    }
});

// ÁõëÂê¨Êñá‰ª∂Êé•Êî∂ÂÆåÊàê
ipcRenderer.on('receive-completed', (event, data) => {
    // Êõ¥Êñ∞Êé•Êî∂ËÆ∞ÂΩï
    if (receives.has(data.fileName)) {
        const receive = receives.get(data.fileName);
        receive.status = 'completed';
        receive.progress = 100;
        receive.filePath = data.filePath;
        
        // Êõ¥Êñ∞Êé•Êî∂ÂàóË°®
        updateReceiveList();
        
        // ÊòæÁ§∫ÈÄöÁü•
        if (Notification.permission === 'granted') {
            const notification = new Notification('Êñá‰ª∂Êé•Êî∂ÂÆåÊàê', {
                body: `${data.fileName} Â∑≤Êé•Êî∂ÂÆåÊàê`,
                icon: 'icon.png'
            });
            
            // ÁÇπÂáªÈÄöÁü•ÊâìÂºÄÊñá‰ª∂
            notification.onclick = () => {
                const { shell } = require('electron');
                shell.showItemInFolder(data.filePath);
            };
        }
    }
});

// Êõ¥Êñ∞Êé•Êî∂ÂàóË°®
function updateReceiveList() {
    if (!receiveList) return; // Èò≤Ê≠¢ÂÖÉÁ¥†‰∏çÂ≠òÂú®
    
    receiveList.innerHTML = Array.from(receives.values())
        .map(receive => `
            <div class="receive-item">
                <div class="receive-info">
                    <div class="receive-name">${receive.fileName}</div>
                    <div class="receive-progress">
                        <div class="progress-bar">
                            <div class="progress-bar-fill" style="width: ${receive.progress}%"></div>
                        </div>
                        <span>${receive.progress.toFixed(1)}% - ${formatFileSize(receive.receivedBytes)} / ${formatFileSize(receive.totalBytes)}</span>
                    </div>
                </div>
                <div class="receive-actions">
                    ${receive.status === 'completed' ? 
                        `<button class="btn-icon" onclick="openReceivedFile('${receive.filePath}')">üìÇ</button>` : 
                        ''}
                </div>
            </div>
        `).join('');
}

// ÊâìÂºÄÊé•Êî∂ÁöÑÊñá‰ª∂
function openReceivedFile(filePath) {
    const { shell } = require('electron');
    shell.showItemInFolder(filePath);
}

// ÂàùÂßãÂåñ
document.addEventListener('DOMContentLoaded', () => {
    // Âä†ËΩΩÂ∑≤‰øùÂ≠òÁöÑÂÖ±‰∫´ÁõÆÂΩï
    const savedDir = localStorage.getItem('sharedDir');
    if (savedDir) {
        loadFiles(savedDir);
    }
    
    // Ê∑ªÂä†Êó•ÂøóÂäüËÉΩÔºåÁî®‰∫éË∞ÉËØï
    window.logFilePath = (path) => {
        console.log(`Êñá‰ª∂Ë∑ØÂæÑ: "${path}"`);
        console.log(`Êñá‰ª∂Ë∑ØÂæÑÈïøÂ∫¶: ${path.length}`);
        console.log(`Êñá‰ª∂Ë∑ØÂæÑÁºñÁ†Å: ${encodeURIComponent(path)}`);
    };
    
    // ËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôê
    if (Notification.permission !== 'granted') {
        Notification.requestPermission();
    }
}); 